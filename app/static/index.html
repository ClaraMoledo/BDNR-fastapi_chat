<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />


    <title>Chat m√≠nimo ‚Äî FastAPI + MongoDB Atlas</title>
  <head>


  <body>
    <!-- HEADER -->
    <header>
      <strong>üî• Chat FastAPI + MongoDB Atlas</strong>
      <div>
        <span id="status">üî¥ desconectado</span>
        <button id="themeBtn">üåô</button>
      </div>
    </header>



    <!-- MAIN -->
    <main>
      <div class="row">
        <input id="room" placeholder="sala (ex: geral)" />
        <input id="username" placeholder="seu nome" />
        <button id="connectBtn">Conectar</button>
      </div>

      <div id="messages"></div>

      <form id="form" autocomplete="off">
        <input id="input" type="text" placeholder="Digite sua mensagem..." />
        <button>Enviar</button>
      </form>
    </main>

    <!-- SCRIPT -->
    <script>
      const $room = document.getElementById('room');
      const $username = document.getElementById('username');
      const $messages = document.getElementById('messages');
      const $form = document.getElementById('form');
      const $input = document.getElementById('input');
      const $connectBtn = document.getElementById('connectBtn');
      const $status = document.getElementById("status");
      const $themeBtn = document.getElementById("themeBtn");

      $room.value = localStorage.getItem('room') || 'geral';
      $username.value = localStorage.getItem('username') || '';

      let ws = null;
      let nextCursor = null;
      let unread = 0;
      let windowFocused = true;
      let typingTimeout;

      const $typing = document.createElement("div");
      $typing.id = "typing";
      $messages.after($typing);

      // ---- Fun√ß√µes utilit√°rias ----
      function setStatus(connected) {
        $status.textContent = connected ? "üü¢ conectado" : "üî¥ desconectado";
      }

      function appendMessage(item) {
        const div = document.createElement("div");
        div.className = "msg";
        div.classList.add(item.username === $username.value ? "self" : "other");
        const when = new Date(item.created_at).toLocaleTimeString();
        div.innerHTML = `<div class="meta">[${when}] <strong>${item.username}</strong></div><div>${item.content}</div>`;
        $messages.appendChild(div);
        div.scrollIntoView({ behavior: "smooth", block: "end" });

        if (!windowFocused) {
          unread++;
          document.title = `(${unread}) Nova mensagem`;
        }
      }

      function appendHistory(items) {
        $messages.innerHTML = "";
        items.forEach(appendMessage);
        if (items.length) {
          nextCursor = items[0]._id;
        }
      }

      // ---- Conex√£o ----
      function connect() {
        const room = ($room.value || 'geral').trim();
        const username = ($username.value || 'anon').trim();
        if (!room) return alert('Informe a sala');
        if (!username) return alert('Informe o nome');

        localStorage.setItem('room', room);
        localStorage.setItem('username', username);

        const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
        const url = `${wsProto}://${location.host}/ws/${encodeURIComponent(room)}`;
        ws = new WebSocket(url);

        ws.onopen = () => setStatus(true);
        ws.onclose = () => setStatus(false);
        ws.onerror = (e) => {
          console.error("WS erro", e);
          setStatus(false);
        };

        ws.onmessage = (evt) => {
          const data = JSON.parse(evt.data);
          if (data.type === "history") {
            appendHistory(data.items || []);
          } else if (data.type === "message") {
            appendMessage(data.item);
            $typing.textContent = "";
          } else if (data.type === "typing") {
            if (data.username !== $username.value) {
              $typing.textContent = `${data.username} est√° digitando...`;
              clearTimeout(typingTimeout);
              typingTimeout = setTimeout(() => ($typing.textContent = ""), 2000);
            }
          }
        };
      }

      // ---- Eventos ----
      $connectBtn.addEventListener('click', () => {
        if (ws) ws.close();
        connect();
      });

      $form.addEventListener('submit', (e) => {
        e.preventDefault();
        const content = $input.value.trim();
        if (!content || !ws || ws.readyState !== WebSocket.OPEN) return;
        ws.send(JSON.stringify({ content, username: $username.value }));
        $input.value = '';
      });

      // Enter envia, Shift+Enter quebra linha
      $input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          $form.requestSubmit();
        }
      });

      // Indicador de digita√ß√£o
      $input.addEventListener("input", () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ typing: true, username: $username.value }));
        }
      });

      // Scroll infinito
      $messages.addEventListener("scroll", async () => {
        if ($messages.scrollTop === 0 && nextCursor) {
          const res = await fetch(`/rooms/${encodeURIComponent($room.value)}/messages?before_id=${nextCursor}&limit=20`);
          const data = await res.json();
          if (data.items.length) {
            const oldHeight = $messages.scrollHeight;
            data.items.forEach(item => {
              const div = document.createElement("div");
              div.className = "msg other";
              const when = new Date(item.created_at).toLocaleTimeString();
              div.innerHTML = `<div class="meta">[${when}] <strong>${item.username}</strong></div><div>${item.content}</div>`;
              $messages.insertBefore(div, $messages.firstChild);
            });
            nextCursor = data.next_cursor;
            $messages.scrollTop = $messages.scrollHeight - oldHeight;
          }
        }
      });

      // Controle de foco (notifica√ß√µes)
      window.addEventListener("focus", () => {
        windowFocused = true;
        unread = 0;
        document.title = "Chat m√≠nimo ‚Äî FastAPI + MongoDB Atlas";
      });
      window.addEventListener("blur", () => {
        windowFocused = false;
      });

      // Dark/Light mode
      $themeBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        $themeBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
      });

      // Conectar automaticamente se j√° houver valores
      if ($room.value && $username.value) {
        connect();
      }
    </script>


<!-- STYLES -->
    <style>
     /* Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        background: #fff8f2;
        color: #333;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        transition: background 0.3s, color 0.3s;
      }

      /* Dark Mode */
      body.dark {
        background: #1c1c1c;
        color: #eee;
      }

      body.dark #messages {
        background: #2a2a2a;
      }

      body.dark .msg.other {
        background: #444;
        color: #eee;
      }


      header {
        padding: 14px 20px;
        background: linear-gradient(135deg, #ff3b3b, #ff7a00, #ffd700);
        color: white;
        font-weight: bold;
        font-size: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
      }

      header div {
        display: flex;
        gap: 12px;
        align-items: center;
      }

      header button {
        background: rgba(255, 255, 255, 0.25);
        border: none;
        padding: 6px 12px;
        border-radius: 20px;
        cursor: pointer;
        color: white;
        font-size: 14px;
        transition: background 0.2s, transform 0.2s;
      }
      header button:hover {
        background: rgba(255, 255, 255, 0.35);
        transform: scale(1.05);
      }

      main {
        flex: 1;
        max-width: 880px;
        margin: 20px auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
        width: 100%;
      }

      #messages {
        flex: 1;
        border-radius: 14px;
        padding: 14px;
        overflow-y: auto;
        background: #fff;
        box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.08);
      }
      body.dark #messages {
        background: #2a2a2a;
      }

      .msg {
        margin: 10px 0;
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 70%;
        animation: fadeIn 0.25s ease;
        line-height: 1.4;
      }

      .msg.self {
        background: #b22222; /* vermelho escuro */
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
      }
      .msg.other {
        background: #e6e6e6;
        color: #2e2e2e;
        margin-right: auto;
        border-bottom-left-radius: 4px;
      }
      body.dark .msg.other {
        background: #444;
        color: #eee;
      }

      .meta {
        font-size: 12px;
        opacity: 0.8;
        margin-bottom: 4px;
      }

      form {
        display: flex;
        gap: 8px;
      }

      input,
      button {
        padding: 12px;
        font-size: 15px;
        border-radius: 10px;
        border: 1px solid #ccc;
        outline: none;
        transition: all 0.2s ease;
      }

      input:focus {
        border-color: #ff7a00;
        box-shadow: 0 0 0 2px rgba(255, 122, 0, 0.3);
      }

      button {
        background: #ff3b3b;
        color: white;
        border: none;
        font-weight: bold;
        cursor: pointer;
        border-radius: 20px;
        padding: 10px 20px;
      }
      button:hover {
        background: #ff7a00;
      }
      button:active {
        transform: scale(0.97);
      }

      .row {
        display: flex;
        gap: 8px;
      }

      .row input {
        flex: 1;
      }

      #typing {
        font-size: 13px;
        color: #666;
        font-style: italic;
        margin: 2px 0;
      }
      body.dark #typing {
        color: #ccc;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

    </style>

  </body>
</html>
