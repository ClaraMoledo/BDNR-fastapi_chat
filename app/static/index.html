<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chat Interativo — FastAPI + MongoDB Atlas</title>
  <style>
    :root {
      --blue: #0019fa;
      --blue-light: #e3f0fe;
      --red: #ff100c;
      --red-dark: #b71c1c;
      --bg: #f7fafd;
      --card: #fff;
      --border: #cfd8dc;
      --shadow: 0 2px 12px rgba(24,119,242,0.09), 0 1.5px 4px rgba(229,57,53,0.05);
      --btn-bg: var(--blue);
      --btn-hover: var(--red);
      --input-bg: #f3f6fa;
      --input-focus: #e3f0fe;
      --font: #213351;
      --header-gradient: linear-gradient(90deg, var(--blue) 0%, var(--red) 100%);
    }
    html.dark {
      --blue: #1100ff;
      --blue-light: #23385e;
      --red: #ff5252;
      --red-dark: #d32f2f;
      --bg: #141c26;
      --card: #1c2636;
      --border: #23324a;
      --btn-bg: #009df8;
      --btn-hover: #910000;
      --input-bg: #182233;
      --input-focus: #23324a;
      --font: #e3eaf3;
      --header-gradient: linear-gradient(90deg, #1100ff 0%, #7c0000 100%);
    }
    body {
      font-family: 'Roboto', Arial, sans-serif;
      background: var(--bg);
      color: var(--font);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      transition: background 0.3s, color 0.3s;
    }
    header {
      background: var(--header-gradient);
      color: #fff;
      padding: 30px 0 22px 0;
      font-size: 2.1rem;
      font-weight: 700;
      text-align: center;
      letter-spacing: 1px;
      box-shadow: var(--shadow);
      border-bottom-left-radius: 24px;
      border-bottom-right-radius: 24px;
      margin-bottom: 18px;
      position: relative;
    }
    .theme-toggle {
      position: absolute;
      top: 18px;
      right: 28px;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 22px;
      padding: 5px 14px 5px 10px;
      color: var(--blue);
      font-size: 1.02rem;
      font-weight: 500;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: background 0.18s, color 0.18s, border 0.18s;
      display: flex;
      align-items: center;
      gap: 6px;
      z-index: 20;
    }
    .theme-toggle:hover {
      background: var(--input-focus);
      color: var(--red);
      border-color: var(--red);
    }
    .theme-toggle svg {
      width: 20px;
      height: 20px;
      vertical-align: middle;
      fill: currentColor;
    }
    .user-status-bar {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--card);
      margin: 0 auto 21px auto;
      max-width: 420px;
      padding: 10px 20px;
      border-radius: 12px;
      box-shadow: var(--shadow);
      font-size: 1.09rem;
      border: 1px solid var(--border);
      justify-content: flex-start;
      transition: background 0.3s, color 0.3s;
    }
    .user-status-dot {
      display: inline-block;
      width: 13px;
      height: 13px;
      border-radius: 50%;
      margin-right: 8px;
      background: var(--red-dark);
      box-shadow: 0 0 7px rgba(24,119,242,0.13);
      transition: background 0.25s;
    }
    .online { background: var(--blue); }
    .offline { background: var(--red-dark); }
    .user-status-label {
      font-weight: 600;
      color: var(--blue);
      font-size: 1rem;
      letter-spacing: 0.5px;
    }
    .user-status-username {
      color: var(--red);
      font-weight: 600;
      font-size: 1.09rem;
      margin-left: 3px;
    }
    .chat-card {
      background: var(--card);
      border-radius: 18px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      max-width: 700px;
      margin: 0 auto;
      padding: 24px 30px 24px 30px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      transition: background 0.3s, color 0.3s, border 0.3s;
    }
    .chat-top-row {
      display: flex;
      gap: 16px;
      margin-bottom: 8px;
    }
    .chat-top-row input {
      flex: 1;
      font-size: 1rem;
      padding: 9px 13px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: var(--input-bg);
      transition: border 0.16s, background 0.16s;
      color: var(--font);
    }
    .chat-top-row input:focus {
      border-color: var(--blue);
      background: var(--input-focus);
    }
    .chat-top-row button {
      background: var(--btn-bg);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      padding: 10px 22px;
      font-size: 1.05rem;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(24,119,242,0.09);
      transition: background 0.18s, box-shadow 0.18s, transform 0.13s;
    }
    .chat-top-row button:hover, .chat-top-row button:focus {
      background: var(--btn-hover);
      box-shadow: 0 2px 8px rgba(229,57,53,0.11);
      transform: scale(1.03);
    }
    #messages {
      border: 1.5px solid var(--blue);
      background: var(--blue-light);
      min-height: 190px;
      max-height: 220px;
      overflow-y: auto;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      font-size: 1.01rem;
      transition: border 0.3s, background 0.3s;
      display: flex;
      flex-direction: column;
      gap: 8px;
      color: var(--font);
    }
    .msg {
      padding: 9px 15px;
      border-radius: 6px;
      background: var(--card);
      border-left: 4px solid var(--blue);
      box-shadow: 0 1px 4px rgba(24,119,242,0.07);
      animation: fadein 0.6s;
      opacity: 0;
      animation-fill-mode: forwards;
      color: var(--font);
    }
    @keyframes fadein { from {opacity:0;} to {opacity:1;} }
    .meta {
      color: var(--blue);
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .meta strong {
      color: var(--red);
      font-weight: 600;
      font-size: 14px;
    }
    .meta em {
      color: var(--blue);
      font-style: normal;
      font-weight: 600;
      font-size: 13px;
      padding: 1px 5px;
      border-radius: 5px;
      background: #e3f0fe;
      transition: background 0.3s;
    }
    html.dark .meta em {
      background: #23324a;
    }
    .meta .clock {
      color: var(--blue);
      font-weight: 600;
      font-size: 12px;
      padding-right: 2px;
    }
    .chat-bottom-row {
      display: flex;
      gap: 12px;
      margin-top: 4px;
    }
    .chat-bottom-row input {
      flex: 1;
      font-size: 1rem;
      padding: 10px 13px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: var(--input-bg);
      transition: border 0.16s, background 0.16s;
      color: var(--font);
    }
    .chat-bottom-row input:focus {
      border-color: var(--blue);
      background: var(--input-focus);
    }
    .chat-bottom-row button {
      background: var(--btn-bg);
      color: #fff;
      border: none;
      font-weight: 600;
      border-radius: 8px;
      padding: 10px 22px;
      font-size: 1.05rem;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(24,119,242,0.09);
      transition: background 0.18s, box-shadow 0.18s, transform 0.13s;
    }
    .chat-bottom-row button:hover, .chat-bottom-row button:focus {
      background: var(--btn-hover);
      box-shadow: 0 2px 8px rgba(229,57,53,0.11);
      transform: scale(1.03);
    }
    #status {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--blue);
      color: #fff;
      padding: 6px 14px;
      font-size: 0.97rem;
      border-radius: 9px;
      box-shadow: 0 2px 9px rgba(24,119,242,0.12);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.5s;
      z-index: 10;
    }
    #status.show { opacity: 1; pointer-events: auto;}
    @media (max-width: 700px) {
      .chat-card {padding: 12px;}
      .chat-top-row button, .chat-bottom-row button {padding: 9px 12px;}
      .theme-toggle {right: 12px; top: 8px;}
    }
  </style>
</head>
<body>
  <header>
    Chat Interativo — FastAPI + MongoDB Atlas
    <button class="theme-toggle" id="themeToggleBtn" title="Alternar tema">
      <svg id="themeIcon" viewBox="0 0 24 24">
        <path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"></path>
      </svg>
      <span id="themeLabel">Escuro</span>
    </button>
  </header>
  <div class="user-status-bar">
    <span id="userStatusDot" class="user-status-dot offline"></span>
    <span id="userStatusLabel" class="user-status-label">Offline</span>
    <span id="userStatusUsername" class="user-status-username"></span>
  </div>
  <div class="chat-card">
    <div class="chat-top-row">
      <input id="room" placeholder="Sala (ex: privado)" autocomplete="off" />
      <input id="username" placeholder="Seu nome" autocomplete="off" />
      <button id="connectBtn" type="button">Conectar</button>
    </div>
    <div id="messages"></div>
    <div class="chat-bottom-row">
      <input id="input" type="text" placeholder="Digite sua mensagem..." autocomplete="off" />
      <button id="sendBtn" type="button">Enviar</button>
    </div>
    <div id="status"></div>
  </div>
  <script>
    const $room = document.getElementById('room');
    const $username = document.getElementById('username');
    const $messages = document.getElementById('messages');
    const $connectBtn = document.getElementById('connectBtn');
    const $status = document.getElementById('status');
    const $userStatusDot = document.getElementById('userStatusDot');
    const $userStatusLabel = document.getElementById('userStatusLabel');
    const $userStatusUsername = document.getElementById('userStatusUsername');
    const $input = document.getElementById('input');
    const $sendBtn = document.getElementById('sendBtn');
    const $themeToggleBtn = document.getElementById('themeToggleBtn');
    const $themeLabel = document.getElementById('themeLabel');
    const $themeIcon = document.getElementById('themeIcon');

    $room.value = localStorage.getItem('room') || 'privado';
    $username.value = localStorage.getItem('username') || '';
    $userStatusUsername.textContent = $username.value || '';

    let ws = null;
    let connected = false;
    let currentRoom = '';
    let currentUsername = '';

    // Theme dark/light
    function setTheme(dark) {
      if (dark) {
        document.documentElement.classList.add('dark');
        $themeLabel.textContent = 'Claro';
        $themeIcon.innerHTML = '<path d="M12 3.25A8.75 8.75 0 1020.75 12 8.75 8.75 0 0012 3.25zm0 15.5A6.75 6.75 0 1118.75 12 6.75 6.75 0 0112 18.75z"></path>';
      } else {
        document.documentElement.classList.remove('dark');
        $themeLabel.textContent = 'Escuro';
        $themeIcon.innerHTML = '<path d="M21 12.79A9 9 0 1111.21 3a7 7 0 109.79 9.79z"></path>';
      }
      localStorage.setItem('chat_theme', dark ? 'dark' : 'light');
    }
    $themeToggleBtn.onclick = () => {
      const dark = !document.documentElement.classList.contains('dark');
      setTheme(dark);
    };
    // Inicializa tema
    (() => {
      const pref = localStorage.getItem('chat_theme');
      if (pref === 'dark' || (pref == null && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        setTheme(true);
      }
    })();

    function showStatus(msg, time=1200) {
      $status.textContent = msg;
      $status.classList.add('show');
      setTimeout(() => $status.classList.remove('show'), time);
    }

    function setOnlineStatus(isOnline) {
      if (isOnline) {
        $userStatusDot.classList.remove('offline');
        $userStatusDot.classList.add('online');
        $userStatusLabel.textContent = "Online";
      } else {
        $userStatusDot.classList.remove('online');
        $userStatusDot.classList.add('offline');
        $userStatusLabel.textContent = "Offline";
      }
    }

    function updateUsernameBar() {
      $userStatusUsername.textContent = $username.value || '';
    }

    function appendMessage(item, highlight=false) {
      const div = document.createElement('div');
      div.className = 'msg';
      const when = new Date(item.created_at || Date.now()).toLocaleTimeString();
      div.innerHTML = `<div class="meta">
          <span class="clock">[${when}]</span>
          <strong>${item.username}</strong>
          em <em>${item.room}</em>
        </div>
        <div>${item.content}</div>`;
      $messages.appendChild(div);
      setTimeout(() => {
        div.style.opacity = 1;
        $messages.scrollTop = $messages.scrollHeight;
      }, 60);
    }

    function appendHistory(items) {
      $messages.innerHTML = '';
      items.forEach(item => appendMessage(item));
    }

    function connect(sendFirstMsg = false, firstMsg = '') {
      const room = ($room.value || 'privado').trim();
      const username = ($username.value || 'anon').trim();
      if (!room) {
        showStatus('Informe a sala!');
        $room.focus();
        return;
      }
      if (!username) {
        showStatus('Informe o nome!');
        $username.focus();
        return;
      }
      localStorage.setItem('room', room);
      localStorage.setItem('username', username);
      updateUsernameBar();

      if (ws && ws.readyState === WebSocket.OPEN && currentRoom === room && currentUsername === username) {
        setOnlineStatus(true);
        if (sendFirstMsg && firstMsg) sendMessage(firstMsg, true);
        return;
      }
      if (ws) ws.close();

      currentRoom = room;
      currentUsername = username;

      const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = `${wsProto}://${location.host}/ws/${encodeURIComponent(room)}`;
      ws = new WebSocket(url);

      ws.onmessage = (evt) => {
        const data = JSON.parse(evt.data);
        if (data.type === 'history') {
          appendHistory(data.items || []);
          showStatus('Histórico carregado!', 1000);
        } else if (data.type === 'message') {
          appendMessage(data.item, true);
        }
      };

      ws.onopen = () => {
        connected = true;
        setOnlineStatus(true);
        $connectBtn.classList.add('connected');
        showStatus('Online!');
        $input.focus();
        if (sendFirstMsg && firstMsg) {
          sendMessage(firstMsg, true);
        }
      };
      ws.onclose = () => {
        connected = false;
        setOnlineStatus(false);
        $connectBtn.classList.remove('connected');
        showStatus('Desconectado!', 1500);
      };
      ws.onerror = () => {
        setOnlineStatus(false);
        showStatus('Erro na conexão!', 1800);
      };
    }

    function sendMessage(msgValue, skipConnect) {
      const content = msgValue.trim();
      const username = $username.value.trim();
      if (!content) {
        showStatus('Digite uma mensagem!');
        $input.focus();
        return;
      }
      if ((!ws || ws.readyState !== WebSocket.OPEN) && !skipConnect) {
        connect(true, content);
        return;
      }
      try {
        ws.send(JSON.stringify({ content, username }));
      } catch (e) {
        showStatus('Erro ao enviar!');
        return;
      }
      setOnlineStatus(true);
      appendMessage({
        room: $room.value,
        username: username,
        content: content,
        created_at: new Date().toISOString()
      }, true);
      $input.value = '';
      $input.focus();
      showStatus('Mensagem enviada!', 900);
    }

    $connectBtn.addEventListener('click', () => {
      connect();
    });

    $sendBtn.addEventListener('click', () => sendMessage($input.value));
    $input.addEventListener('keydown', e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage($input.value);
      }
    });

    $room.addEventListener('keydown', e => { if (e.key==="Enter") $connectBtn.click(); });
    $username.addEventListener('keydown', e => { if (e.key==="Enter") $connectBtn.click(); });
    $username.addEventListener('input', updateUsernameBar);

    setOnlineStatus(false);
    updateUsernameBar();
  </script>
</body>

</html>