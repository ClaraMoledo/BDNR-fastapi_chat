<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />


    <title>Chat m√≠nimo ‚Äî FastAPI + MongoDB Atlas</title>
  <head>


  <body>
    <!-- HEADER -->
    <header>
      <strong>Chat m√≠nimo ‚Äî FastAPI + MongoDB Atlas</strong>
      <div>
        <span id="status">üî¥ desconectado</span>
        <button id="themeBtn">üåô</button>
      </div>
    </header>


    <!-- MAIN -->
    <main>
      <div class="row">
        <input id="room" placeholder="sala (ex: geral)" />
        <input id="username" placeholder="seu nome" />
        <button id="connectBtn">Conectar</button>
      </div>

      <div id="messages"></div>

      <form id="form" autocomplete="off">
        <input id="input" type="text" placeholder="Digite sua mensagem..." />
        <button>Enviar</button>
      </form>
    </main>

    <!-- SCRIPT -->
    <script>
      const $room = document.getElementById('room');
      const $username = document.getElementById('username');
      const $messages = document.getElementById('messages');
      const $form = document.getElementById('form');
      const $input = document.getElementById('input');
      const $connectBtn = document.getElementById('connectBtn');

      $room.value = localStorage.getItem('room') || 'geral';
      $username.value = localStorage.getItem('username') || '';

      let ws = null;

      function appendMessage(item) {
        const div = document.createElement('div');
        div.className = 'msg';
        const when = new Date(item.created_at).toLocaleTimeString();
        div.innerHTML = `<div class="meta">[${when}] <strong>${item.username}</strong> em <em>${item.room}</em></div>` +
                        `<div>${item.content}</div>`;
        $messages.appendChild(div);
        $messages.scrollTop = $messages.scrollHeight;
      }

      function appendHistory(items) {
        $messages.innerHTML = '';
        items.forEach(appendMessage);
      }

      function connect() {
        const room = ($room.value || 'geral').trim();
        const username = ($username.value || 'anon').trim();
        if (!room) return alert('Informe a sala');
        if (!username) return alert('Informe o nome');

        localStorage.setItem('room', room);
        localStorage.setItem('username', username);

        const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
        const url = `${wsProto}://${location.host}/ws/${encodeURIComponent(room)}`;
        ws = new WebSocket(url);

        ws.onmessage = (evt) => {
          const data = JSON.parse(evt.data);
          if (data.type === 'history') {
            appendHistory(data.items || []);
          } else if (data.type === 'message') {
            appendMessage(data.item);
          }
        };

        ws.onopen = () => console.log('WS conectado');
        ws.onclose = () => console.log('WS desconectado');
        ws.onerror = (e) => console.error('WS erro', e);
      }

      $connectBtn.addEventListener('click', () => {
        if (ws) ws.close();
        connect();
      });

      $form.addEventListener('submit', (e) => {
        e.preventDefault();
        const content = $input.value.trim();
        if (!content || !ws || ws.readyState !== WebSocket.OPEN) return;
        ws.send(JSON.stringify({ content, username: $username.value }));
        $input.value = '';
      });
      
      const $typing = document.createElement("div");
      $typing.id = "typing";
      $messages.after($typing);

      const $themeBtn = document.getElementById("themeBtn");

      // Alternar tema
      $themeBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        $themeBtn.textContent = document.body.classList.contains("dark") ? "‚òÄÔ∏è" : "üåô";
      });

      function appendMessage(item) {
        const div = document.createElement("div");
        div.className = "msg";
        div.classList.add(item.username === $username.value ? "self" : "other");
        const when = new Date(item.created_at).toLocaleTimeString();
        div.innerHTML = `<div class="meta">[${when}] <strong>${item.username}</strong></div>` +
                        `<div>${item.content}</div>`;
        $messages.appendChild(div);
        div.scrollIntoView({ behavior: "smooth", block: "end" });
      }

      // Indicador de digita√ß√£o
      let typingTimeout;
      $input.addEventListener("input", () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ typing: true, username: $username.value }));
        }
      });

      // Receber mensagens
      ws.onmessage = (evt) => {
        const data = JSON.parse(evt.data);
        if (data.type === "history") {
          appendHistory(data.items || []);
        } else if (data.type === "message") {
          appendMessage(data.item);
          $typing.textContent = "";
        } else if (data.type === "typing") {
          $typing.textContent = `${data.username} est√° digitando...`;
          clearTimeout(typingTimeout);
          typingTimeout = setTimeout(() => ($typing.textContent = ""), 2000);
        }
      };
      // Indicador de status da conex√£o
      const $status = document.getElementById("status");
      function setStatus(connected) {
        $status.textContent = connected ? "üü¢ conectado" : "üî¥ desconectado";
      }

      $input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          $form.requestSubmit();
        }
      });

      let nextCursor = null;

      $messages.addEventListener("scroll", async () => {
        if ($messages.scrollTop === 0 && nextCursor) {
          const res = await fetch(`/rooms/${encodeURIComponent($room.value)}/messages?before_id=${nextCursor}&limit=20`);
          const data = await res.json();
          if (data.items.length) {
            const oldHeight = $messages.scrollHeight;
            data.items.forEach(item => {
              const div = document.createElement("div");
              div.className = "msg other";
              const when = new Date(item.created_at).toLocaleTimeString();
              div.innerHTML = `<div class="meta">[${when}] <strong>${item.username}</strong></div><div>${item.content}</div>`;
              $messages.insertBefore(div, $messages.firstChild);
            });
            nextCursor = data.next_cursor;
            $messages.scrollTop = $messages.scrollHeight - oldHeight; // mant√©m posi√ß√£o
          }
        }
      });

      // Atualizar cursor ao receber hist√≥rico inicial
      function appendHistory(items) {
        $messages.innerHTML = "";
        items.forEach(appendMessage);
        if (items.length) {
          nextCursor = items[0]._id;
        }
      }

      let unread = 0;
      let windowFocused = true;

      window.addEventListener("focus", () => {
        windowFocused = true;
        unread = 0;
        document.title = "Chat m√≠nimo ‚Äî FastAPI + MongoDB Atlas";
      });
      window.addEventListener("blur", () => {
        windowFocused = false;
      });

      function appendMessage(item) {
        const div = document.createElement("div");
        div.className = "msg";
        div.classList.add(item.username === $username.value ? "self" : "other");
        const when = new Date(item.created_at).toLocaleTimeString();
        div.innerHTML = `<div class="meta">[${when}] <strong>${item.username}</strong></div><div>${item.content}</div>`;
        $messages.appendChild(div);
        div.scrollIntoView({ behavior: "smooth", block: "end" });

        if (!windowFocused) {
          unread++;
          document.title = `(${unread}) Nova mensagem`;
        }
      }


      // Atualizar status da conex√£o
      ws.onopen = () => setStatus(true);
      ws.onclose = () => setStatus(false);
      ws.onerror = (e) => {
        console.error("WS erro", e);
        setStatus(false);
      };

      // Conectar automaticamente se j√° houver sala e nome
      if ($room.value && $username.value) {
        connect();
      }

    </script>

<!-- STYLES -->
    <style>
      /* Reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Roboto, Arial, sans-serif;
        background: #f5f7fa;
        color: #333;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        transition: background 0.3s, color 0.3s;
      }

      body.dark {
        background: #1e1e2f;
        color: #eee;
      }

      header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #4a90e2, #357abd);
        color: white;
        font-weight: bold;
        font-size: 18px;
        letter-spacing: 0.5px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      header button {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
        color: white;
        font-size: 14px;
      }
      header button:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      main {
        flex: 1;
        max-width: 880px;
        margin: 20px auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
      }

      #messages {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 12px;
        padding: 12px;
        overflow-y: auto;
        background: #fff;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
      }
      body.dark #messages {
        background: #2a2a40;
        border-color: #444;
      }

      .msg {
        margin: 10px 0;
        padding: 10px 14px;
        border-radius: 12px;
        max-width: 70%;
        animation: fadeIn 0.3s ease;
      }

      .msg.self {
        background: #4a90e2;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
      }
      .msg.other {
        background: #eee;
        color: #333;
        margin-right: auto;
        border-bottom-left-radius: 4px;
      }
      body.dark .msg.other {
        background: #444;
        color: #eee;
      }

      .meta {
        font-size: 12px;
        opacity: 0.8;
        margin-bottom: 4px;
      }

      form {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      input,
      button {
        padding: 12px;
        font-size: 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        outline: none;
        transition: all 0.2s ease;
      }

      input:focus {
        border-color: #4a90e2;
        box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.3);
      }

      button {
        background: #4a90e2;
        color: white;
        border: none;
        font-weight: bold;
        cursor: pointer;
      }
      button:hover {
        background: #357abd;
      }
      button:active {
        transform: scale(0.97);
      }

      .row {
        display: flex;
        gap: 8px;
      }

      .row input {
        flex: 1;
      }

      #typing {
        font-size: 13px;
        color: #666;
        font-style: italic;
        margin: 4px 0;
      }

      /* Anima√ß√µes */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(6px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

    </style>

  </body>
</html>
